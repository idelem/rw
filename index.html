<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>rw</title>
        <base href="/" target="_top">
        <style type="text/css">
            :root {
                --page-color: #171717;
                --text-color: #cccccc;
                --mark-color: #47ebc8;
                --grid-color: #282828;
            }
            :focus {
                outline: 0;
            }
            body {
                height: 100vh;
                margin: 0;
                overflow: hidden;
                background: var(--page-color);
                color: var(--text-color);
                position: relative;
                font-family: "inconsolata", monospace;
            }
            #calendar {
                position: absolute;
                left:0;
                top: 0;
                bottom: 0;
                right: 0;
                height: 40vh;
                width: 36em;
                margin: auto;
            }
            #nav {
                display: flex;
                justify-content: space-evenly;
            }
            #week {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
            }
            #tasks {

            }
            #nav, #week {
                width: 21em;
            }
            #nav > *, #week > * {
                padding: 5px 0;
            }
            #input {
                padding: 5px 0;
            }
            #toast {
                opacity: 0;
                position: fixed;
                bottom: 2em;
                left: 50%;
                background-color: var(--grid-color);
                padding: 0.5em 1em;
                z-index: 1;
            }
            #toast.show {
                animation-name: fadeinout;
                animation-duration: 1s;
            }
            @-webkit-keyframes fadeinout {
                from {bottom: 1em; opacity: 0;}
                25% {bottom: 2em; opacity: 1;}
                75% {bottom: 2em; opacity: 1;}
                to {bottom: 1em; opacity: 0;}
            }
            @keyframes fadeinout {
                from {bottom: 1em; opacity: 0;}
                25% {bottom: 2em; opacity: 1;}
                75% {bottom: 2em; opacity: 1;}
                to {bottom: 1em; opacity: 0;}
            }
            input {
                /* text-align: right; */
                margin-left: 21em;
                font-size: 1rem;
                color: var(--text-color);
                background-color: var(--page-color);
                border: 0;
                outline: 0;
                width: 100%;
                font-family: inherit;
                caret-color: var(--mark-color);
            }
            .weekend {
                color: var(--mark-color);
            }
            .task {
                display: grid;
                grid-template-columns: repeat(12, 1fr);
                padding: 5px 0;
                position: relative
            }
            .ops {
                position: absolute;
                left: 100%;
                width: auto;
                /* vertical center
                top: 50%;
                transform: translate(0, -50%);
                */
                padding-top: 5px;
                display: flex;
            }
            .op {
                opacity: 0.5;
                padding: 0 5px;
            }
            .bullet {

            }
            .label {
                grid-column-start: 8;
                grid-column-end: 12;
            }
            .clickable {
                cursor:pointer;
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div id="toast"></div>
        <script>

            function get_nth_date_of_week (date, offset, start=1) {
                var that_day = new Date(date);
                that_day.setDate(date.getDate() - date.getDay() + offset + start);
                return that_day;
            }

            function is_weekend(date) {
                var day = date.getDay();
                return (day === 6) || (day === 0);
            }

            function show_toast(label) {
                var toast = document.getElementById("toast");
                toast.innerHTML = label;
                toast.classList.add("show");
                setTimeout(() => {toast.classList.remove("show"); }, 1000);
            }

            function Task (label="") {
                this.id = null;
                this.label = label;
                this.created_on = null;
                this.starts_on = null;
                this.ends_on = null;
                this.finished_on = null;
                this.is_finished = function(){
                    return this.finished_on != null;
                }
                this.done_on = [];
            }

            function View () {
                this.data = {}; // later read from storage
                this.tasks = [];
                this.dates = {};
                this.today = null;
                this.focus = null;

                this.install = function (host) {
                    this.today = new Date();

                    this.calendar_el = document.createElement('div');
                    this.calendar_el.setAttribute('id', 'calendar');

                    this.year_el = document.createElement('span');
                    this.year_el.setAttribute('id', 'year');
                    this.month_el = document.createElement('span');
                    this.month_el.setAttribute('id', 'month');

                    this.prev_el = document.createElement('a');
                    this.prev_el.onclick = () => {this.prev()};
                    this.prev_el.textContent = '<';
                    this.next_el = document.createElement('a');
                    this.next_el.onclick = () => {this.next()};
                    this.next_el.textContent = '>';
                    this.today_el = document.createElement('a');
                    this.today_el.onclick = () => {this.today = new Date(); this.update();};
                    this.today_el.textContent = '.';

                    this.nav_el = document.createElement('div');
                    this.nav_el.setAttribute('id', 'nav');
                    this.nav_el.appendChild(this.prev_el);
                    this.nav_el.appendChild(this.year_el);
                    this.nav_el.appendChild(this.today_el);
                    this.nav_el.appendChild(this.month_el);
                    this.nav_el.appendChild(this.next_el);

                    this.week = [];
                    this.week_el = document.createElement('div');
                    this.week_el.setAttribute('id', 'week');

                    this.tasks_el = document.createElement('div');
                    this.tasks_el.setAttribute('id', 'tasks');
                    // input
                    this.input_el = document.createElement('input');
                    this.input_el.setAttribute("type", "text");
                    this.input_el.setAttribute("placeholder", "what's your next task?");
                    this.input_el.setAttribute('id', 'input');
                    this.input_el.onkeydown = (e) => {if(e.keyCode == 13) {this.add_task(this.input_el.value); this.input_el.value = '';}}

                    this.calendar_el.appendChild(this.nav_el);
                    this.calendar_el.appendChild(this.week_el);
                    this.calendar_el.appendChild(this.tasks_el);
                    this.calendar_el.appendChild(this.input_el);

                    host.appendChild(this.calendar_el);

                    this.update();
                }

                /* currently we only worry about weekly views
                */

                this.prev = function () {
                    this.today.setDate(this.today.getDate()-7);
                    this.update();
                }

                this.next = function () {
                    this.today.setDate(this.today.getDate()+7);
                    this.update();
                }

                this.update = function () {
                    this.year = this.today.getFullYear();
                    this.month = this.today.getMonth();
                    this.year_el.innerText = `${this.year}`;
                    this.month_el.innerText = `${this.month + 1}`;
                    
                    this.week_el.innerHTML = '';
                    for (var i = 0; i < 7; i++) {
                        var day = get_nth_date_of_week(this.today, i);
                        var date = day.getDate();
                        this.week.push(date);
                        var day_el = document.createElement('span');
                        day_el.innerText = `${date}`;
                        if (is_weekend(day))
                            day_el.classList.add("weekend");
                        this.week_el.appendChild(day_el);
                    }

                    this.tasks_el.innerHTML = '';
                    this.tasks.forEach((element, i) => {
                        var task_el = document.createElement('span');
                        task_el.classList.add("task");
                        // todo: bullets
                        // label
                        var label_el = document.createElement('span');
                        label_el.innerText = `${element.label}`;
                        label_el.setAttribute("contentEditable", true);
                        label_el.classList.add("label");
                        label_el.onclick = (e) => {label_el.onblur = (e) => {this.update_label(label_el, element); console.log(element)};};
                        task_el.appendChild(label_el);
                        // ops
                        var ops_el = document.createElement('span');
                        ops_el.classList.add("ops");
                        ops_el.innerHTML = `<span class="clickable op">c</span> <span class="clickable op">x</span>`;
                        var copy_el = ops_el.firstChild;
                        copy_el.onclick = async (e) => {await navigator.clipboard.writeText(label_el.innerText); show_toast("copied!")};
                        var del_el = copy_el.nextElementSibling;
                        del_el.onclick = (e) => {this.delete_task(i); show_toast("deleted!")};

                        task_el.appendChild(ops_el);

                        this.tasks_el.appendChild(task_el);
                    });
                }

                this.add_task = function (label) {
                    if (label === "")
                        return;
                    var task = new Task(label);
                    this.tasks.push(task);
                    // console.log(this.tasks);
                    this.update();
                }

                this.update_label = function (label_el, task) {
                    task.label = label_el.innerText;
                }

                this.delete_task = function (i) {
                    this.tasks.splice(i, 1);
                    this.update();
                }
            }

            window.onload = function () {
                const rw = new View();
                rw.install(document.body);
            }

            document.onkeydown = function keyDown (e) {

            }
        </script>
    </body>
</html>